#!/bin/sh
set -e

TOP="$PWD" # Assumes that user is in the root of the repository!
LOCAL_BIN_PATH="$TOP/bin"

(cd pkg/hs/nauvad; stack --local-bin-path="$LOCAL_BIN_PATH" --silent install)

function die () {
    echo $1
    exit 1
}

DIR="$TOP/product/$1/dev"
if ! test -d "$DIR"; then
    die "$DIR does not exist!"
fi

NAUVAD_PUBLIC_PATH=$TOP/pkg/hs/nauvad/public
export NAUVAD_PUBLIC_PATH

cd $DIR
exec "$LOCAL_BIN_PATH/nauvad" --command="stack ghci" --test=:main --warnings
